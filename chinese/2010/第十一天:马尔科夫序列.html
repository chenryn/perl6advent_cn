	<div class="post" id="post-2754">
		<h2>2010年Perl6圣诞月历(十一)马尔科夫序列</h2>
		<div class="info">
			<span class="date">2011年12月14日</span>
			<span class="author"><a href="http://chenlinux.com/author/admin" title="由 admin 发布" rel="author">admin</a></span>
			
			
				<span class="addcomment"><a href="#respond">发表评论</a></span>
				<span class="comments"><a href="#comments">阅读评论</a></span>
			
			<div class="fixed"></div>
		</div>
		<div class="content">
			<p>（译者注：完全不知道什么是马尔科夫链，所以翻译纯粹靠看代码……诚求数学科普）<br />
<hr />
第四天的时候，我开玩笑似的提到了有非数值型的序列。今天我就来介绍这么一个东东——基于一个对文本使用马尔科夫链的想法。我们在前两个元素的基础上，随机的定义下一个元素。下面的示例里包含了一个示例文本，以便让运行结果看起来更像一个语言模型~</p>
<div class="wp_syntax"><div class="code"><pre class="perl" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">use</span> v6<span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">use</span> List<span style="color: #339933;">::</span><span style="color: #006600;">Utils</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #b1b100;">my</span> <span style="color: #0000ff;">$model</span><span style="color: #339933;">-</span>text <span style="color: #339933;">=</span> $<span style="color: #0000ff;">*IN</span><span style="color: #339933;">.</span>slurp<span style="color: #339933;">.</span><span style="color: #000066;">lc</span><span style="color: #339933;">;</span>
<span style="color: #0000ff;">$model</span><span style="color: #339933;">-</span>text <span style="color: #339933;">.=</span>subst<span style="color: #009900;">&#40;</span><span style="color: #009966; font-style: italic;">/&lt;[_']&gt;/</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">&quot;&quot;</span><span style="color: #339933;">,</span> <span style="color: #339933;">:</span>global<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<span style="color: #0000ff;">$model</span><span style="color: #339933;">-</span>text <span style="color: #339933;">.=</span>subst<span style="color: #009900;">&#40;</span><span style="color: #009966; font-style: italic;">/&lt;-alpha&gt;+/</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">&quot; &quot;</span><span style="color: #339933;">,</span> <span style="color: #339933;">:</span>global<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<span style="color: #b1b100;">my</span> <span style="color: #0000ff;">%next</span><span style="color: #339933;">-</span>step<span style="color: #339933;">;</span>
<span style="color: #b1b100;">for</span> sliding<span style="color: #339933;">-</span>window<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">$model</span><span style="color: #339933;">-</span>text<span style="color: #339933;">.</span>comb<span style="color: #339933;">,</span> <span style="color: #cc66cc;">3</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">-&gt;</span> <span style="color: #0000ff;">$a</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">$b</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">$c</span> <span style="color: #009900;">&#123;</span>
    <span style="color: #0000ff;">%next</span><span style="color: #339933;">-</span>step<span style="color: #009900;">&#123;</span><span style="color: #0000ff;">$a</span> <span style="color: #339933;">~</span> <span style="color: #0000ff;">$b</span><span style="color: #009900;">&#125;</span><span style="color: #009900;">&#123;</span><span style="color: #0000ff;">$c</span><span style="color: #009900;">&#125;</span><span style="color: #339933;">++;</span>
<span style="color: #009900;">&#125;</span>
<span style="color: #b1b100;">my</span> <span style="color: #0000ff;">$first</span> <span style="color: #339933;">=</span> <span style="color: #0000ff;">$model</span><span style="color: #339933;">-</span>text<span style="color: #339933;">.</span><span style="color: #000066;">substr</span><span style="color: #009900;">&#40;</span><span style="color: #cc66cc;">0</span><span style="color: #339933;">,</span> <span style="color: #cc66cc;">1</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<span style="color: #b1b100;">my</span> <span style="color: #0000ff;">$second</span> <span style="color: #339933;">=</span> <span style="color: #0000ff;">$model</span><span style="color: #339933;">-</span>text<span style="color: #339933;">.</span><span style="color: #000066;">substr</span><span style="color: #009900;">&#40;</span><span style="color: #cc66cc;">1</span><span style="color: #339933;">,</span> <span style="color: #cc66cc;">1</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<span style="color: #b1b100;">my</span> <span style="color: #0000ff;">@chain</span> <span style="color: #339933;">:=</span> <span style="color: #0000ff;">$first</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">$second</span><span style="color: #339933;">,</span> <span style="color: #339933;">-&gt;</span> <span style="color: #0000ff;">$a</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">$b</span> <span style="color: #009900;">&#123;</span> <span style="color: #0000ff;">%next</span><span style="color: #339933;">-</span>step<span style="color: #009900;">&#123;</span><span style="color: #0000ff;">$a</span> <span style="color: #339933;">~</span> <span style="color: #0000ff;">$b</span><span style="color: #009900;">&#125;</span><span style="color: #339933;">.</span>roll <span style="color: #009900;">&#125;</span> <span style="color: #339933;">...</span> <span style="color: #339933;">*;</span>
say <span style="color: #0000ff;">@chain</span><span style="color: #339933;">.</span>munch<span style="color: #009900;">&#40;</span><span style="color: #cc66cc;">80</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre></div></div>
<p>在use语句下面，代码主要分为三部分：<br />
第一段用来输入示例文本，并去除所有非字母的字符。首先用slurp读取标准输入($*IN)到标量，然后用lc改写标量的内容成小写字母。接着第一个subst命令，把所有的下划线和单引号删除掉；第二个subst命令，把所有的非字母字符改成空格。<br />
第二段用List::Utils模块中的sliding-window函数结合一点Perl5的哈希魔术：$modle-text.comb分割内容成一个个独立的字符串；sliding-window函数遍历列表，并且返回从第一个被读取元素开始往后总共N个元素（本例中为3个），意思就是说：第一次获得第1、2、3个元素，第二次是2,、3、4，……<br />
在循环中，我们构建一个哈希结构。这个哈希的外层键为每次的三个连续字母的前两个，内层键为第三个字母，值为该字母出现在前两个字母后面的次数。比如说，在我导入一篇Aqualong的歌词后，这个%next-step{“qu”}看起来就是这样子的了：</p>
<div class="wp_syntax"><div class="code"><pre class="perl" style="font-family:monospace;"><span style="color: #009900;">&#123;</span><span style="color: #ff0000;">&quot;a&quot;</span> <span style="color: #339933;">=&gt;</span> <span style="color: #cc66cc;">5</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">&quot;e&quot;</span> <span style="color: #339933;">=&gt;</span> <span style="color: #cc66cc;">2</span><span style="color: #009900;">&#125;</span></pre></div></div>
<p>也就是说，文中有q和u的话，那么后面有5次出现了a（比如Aqualong），2次出现了e（比如question、requests）。<br />
第三段用我们已经说过的知识来构建序列。首先从示例文本里获取最开头的两个元素，然后用&#8217;->$a,$b{%next-step{$a~$b}.roll}&#8217;生成第三个元素。这个roll的方法，就是通过哈希的值做权重，决定随即返回哪个（比如上例中，如果roll7次，那么5次返回a，2次返回e）。如果前面两个元素组成的键没有对应的值，就返回一个undef，结束序列的构建。<br />
最后，用mutch方法获取序列的前80个元素，即便序列过早结束，也不会出什么异常。</p>
<p>对Aqualong的歌词运行这个脚本最终得到如下序列：</p>
<pre>t carealven thead you he sing i withe and upon a put saves pinsest to laboonfeet” and “t steall gets sill a creat ren ther he crokin whymn the gook sh an arlieves grac</pre>
<p>（因为歌词文件的开头是一些ASCII码，被替换到最后就是一个t了~）<br />
注意：这个脚本会自己猜测字符的编码，但凡是可以被perl6认作是字母的，它都处理。所以如果你用标准的“Land der Berge”文件做输入，得到的就是&#8217;laß in ber bist brüften las schören zeites öst froher land der äckerzeichöne lan&#8217;（好吧，先祈祷你的浏览器支持这种文字~~）。<br />
然后还有警告一声：在我写这篇文章的时候，Perl6频道里正在反思Hash.roll方法到底应该用来做什么。目前在Rakudo中的部分实现是KeyBag.roll。等到全部搞定的时候，如果和规范上有差距，可能会替换掉KeyBag。<br />
而且，现在你也可以选择另一个运行方法。把%next-step{$a ~ $b}{$c}++改成%next-step.push($a ~ $b, $c)，%next-step会构建成数组的哈希。每个数组都列出所有跟在前两个元素后面的字母，一个字母出现过多少回，它在数组里就会重复多少次。这样在序列上用roll的时候，一样可以达到权重的目的。</p>
<div id="downaspdf">
                    <a title="下载此文章的 PDF 文档" href="http://chenlinux.com/wp-content/plugins/down-as-pdf/generate.php?id=2754">
                      <span>Download as PDF</span>
                    </a>
                </div>
			<div class="fixed"></div>
		</div>
		<div class="under">
			<span class="categories">分类: </span><span><a href="http://chenlinux.com/category/ops/script" title="查看 脚本 中的全部文章" rel="category tag">脚本</a></span>
			<span class="tags">标签: </span><span><a href="http://chenlinux.com/tag/perl" rel="tag">perl</a>, <a href="http://chenlinux.com/tag/perl6advent" rel="tag">perl6advent</a></span>
		</div>
	</div>
