




	<div class="post" id="post-2778">


		<h2>2010年Perl6圣诞月历(十五)调用本地库</h2>


		<div class="info">


			<span class="date">2011年12月14日</span>


			<span class="author"><a href="http://chenlinux.com/author/admin" title="由 admin 发布" rel="author">admin</a></span>

			

			

				<span class="addcomment"><a href="#respond">发表评论</a></span>


				<span class="comments"><a href="#comments">阅读评论</a></span>


			

			<div class="fixed"></div>


		</div>


		<div class="content">


			<p>如果你已经用过一段时间的perl5，你应该碰过一些结尾是&#8217;::XS&#8217;的模块了。或者你可能自己都写过一个？那你可以跳过这段……XS是perl中调用本地C库的方式。这种方式跑起来可是相当棒。不过写这样的模块，可需要付出点努力和汗水才行。毕竟你需要搞定C编译器和代码。如果你只是想简单的想把事情做出来而已，那写XS可不是啥有趣的事情了。<br />
Perl6已经做了一些工作减少这些力气活。你可以使用一些外部代码，开头可以这样：</p>

<div class="wp_syntax"><div class="code"><pre class="perl" style="font-family:monospace;"><span style="color: #666666; font-style: italic;">#!/usr/bin/env perl6</span>
<span style="color: #000000; font-weight: bold;">use</span> v6<span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">use</span> NativeCall<span style="color: #339933;">;</span></pre></div></div>

<p>这就行了。NativeCall来完成和C库交流的复杂工作~你不需要自己去编译什么了。在Rakudo里，你只需要安装<a href="https://github.com/jnthn/zavolaj">zavolaj</a>就可以了。<br />
好了，现在让我们做点有趣的事情吧。我来示范下把XMMS2的C语言客户端说明的第一部分用perl6搞定。<br />
首先，NativeCall需要知道怎么跟C库打交道。目前他可以相互转换的有字符串、数值，和一个叫OpaquePointer（不透明指针？）的东西。这个不透明指针是为数据库连接句柄这类东西准备的。<br />
在这次的示例代码里，我们要处理的是一个比较奇怪的结构和套接字。让我们假设这些是不透明指针的子类，这没什么实质性后果，但是写起来简单很多：</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">class</span> xmmsc_connection_t <span style="color: #ff7700;font-weight:bold;">is</span> OpaquePointer<span style="color: #66cc66;">;</span>
<span style="color: #ff7700;font-weight:bold;">class</span> xmmsc_result_t <span style="color: #ff7700;font-weight:bold;">is</span> OpaquePointer<span style="color: #66cc66;">;</span>
<span style="color: #ff7700;font-weight:bold;">class</span> xmmsv_t <span style="color: #ff7700;font-weight:bold;">is</span> OpaquePointer<span style="color: #66cc66;">;</span></pre></div></div>

<p>现在是我们要用的这些C函数，按照字母顺序排列。这里面有一个函数(译者注：即xmmsv_get_error)和其他的不同——原版的C代码中预期一个**char传入，或者说，需要一个空间写入字符串。我们设定为rw的Str就好啦：</p>

<div class="wp_syntax"><div class="code"><pre class="perl" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">sub</span> xmmsc_connect<span style="color: #009900;">&#40;</span>xmmsc_connection_t<span style="color: #339933;">,</span> Str <span style="color: #0000ff;">$path</span><span style="color: #009900;">&#41;</span>
    returns Int
    is native<span style="color: #009900;">&#40;</span><span style="color: #ff0000;">'libxmmsclient'</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #339933;">...</span> <span style="color: #009900;">&#125;</span>
&nbsp;
<span style="color: #000000; font-weight: bold;">sub</span> xmmsc_get_last_error<span style="color: #009900;">&#40;</span>xmmsc_connection_t<span style="color: #009900;">&#41;</span>
    returns Str
    is native<span style="color: #009900;">&#40;</span><span style="color: #ff0000;">'libxmmsclient'</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #339933;">...</span> <span style="color: #009900;">&#125;</span>
&nbsp;
<span style="color: #000000; font-weight: bold;">sub</span> xmmsc_init<span style="color: #009900;">&#40;</span>Str <span style="color: #0000ff;">$clientname</span><span style="color: #009900;">&#41;</span>
    returns xmmsc_connection_t
    is native<span style="color: #009900;">&#40;</span><span style="color: #ff0000;">'libxmmsclient'</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #339933;">...</span> <span style="color: #009900;">&#125;</span>
&nbsp;
<span style="color: #000000; font-weight: bold;">sub</span> xmmsc_playback_start<span style="color: #009900;">&#40;</span>xmmsc_connection_t<span style="color: #009900;">&#41;</span>
    returns xmmsc_result_t
    is native<span style="color: #009900;">&#40;</span><span style="color: #ff0000;">'libxmmsclient'</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #339933;">...</span> <span style="color: #009900;">&#125;</span>
&nbsp;
<span style="color: #000000; font-weight: bold;">sub</span> xmmsc_result_get_value<span style="color: #009900;">&#40;</span>xmmsc_result_t<span style="color: #009900;">&#41;</span>
    returns xmmsv_t
    is native<span style="color: #009900;">&#40;</span><span style="color: #ff0000;">'libxmmsclient'</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #339933;">...</span> <span style="color: #009900;">&#125;</span>
&nbsp;
<span style="color: #000000; font-weight: bold;">sub</span> xmmsc_result_unref<span style="color: #009900;">&#40;</span>xmmsc_result_t<span style="color: #009900;">&#41;</span>
    is native<span style="color: #009900;">&#40;</span><span style="color: #ff0000;">'libxmmsclient'</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #339933;">...</span> <span style="color: #009900;">&#125;</span>
&nbsp;
<span style="color: #000000; font-weight: bold;">sub</span> xmmsc_result_wait<span style="color: #009900;">&#40;</span>xmmsc_result_t<span style="color: #009900;">&#41;</span>
    is native<span style="color: #009900;">&#40;</span><span style="color: #ff0000;">'libxmmsclient'</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #339933;">...</span> <span style="color: #009900;">&#125;</span>
&nbsp;
<span style="color: #000000; font-weight: bold;">sub</span> xmmsc_unref<span style="color: #009900;">&#40;</span>xmmsc_connection_t<span style="color: #009900;">&#41;</span>
    is native<span style="color: #009900;">&#40;</span><span style="color: #ff0000;">'libxmmsclient'</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #339933;">...</span> <span style="color: #009900;">&#125;</span>
&nbsp;
<span style="color: #000000; font-weight: bold;">sub</span> xmmsv_get_error<span style="color: #009900;">&#40;</span>xmmsv_t<span style="color: #339933;">,</span> Str <span style="color: #0000ff;">$error</span> is rw<span style="color: #009900;">&#41;</span>
    returns Int
    is native<span style="color: #009900;">&#40;</span><span style="color: #ff0000;">'libxmmsclient'</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #339933;">...</span> <span style="color: #009900;">&#125;</span>
&nbsp;
<span style="color: #000000; font-weight: bold;">sub</span> xmmsv_is_error<span style="color: #009900;">&#40;</span>xmmsv_t<span style="color: #009900;">&#41;</span>
    returns Int
    is native<span style="color: #009900;">&#40;</span><span style="color: #ff0000;">'libxmmsclient'</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #339933;">...</span> <span style="color: #009900;">&#125;</span></pre></div></div>

<p>为了避免写C代码，我们再做一个漂亮的封装对象：</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">class</span> XMMS2::Client <span style="color: black;">&#123;</span>
    has xmmsc_connection_t $<span style="color: #66cc66;">!</span>connection<span style="color: #66cc66;">;</span>
&nbsp;
    method <span style="color: #dc143c;">new</span><span style="color: black;">&#40;</span>$client_name = <span style="color: #483d8b;">'perl6'</span>, $path = <span style="color: #66cc66;">%*</span>ENV<span style="color: black;">&#41;</span> <span style="color: black;">&#123;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">bless</span><span style="color: black;">&#40;</span><span style="color: #66cc66;">*</span>, :$client_name, :$path<span style="color: black;">&#41;</span><span style="color: #66cc66;">;</span>
    <span style="color: black;">&#125;</span>
&nbsp;
    method play returns Bool <span style="color: black;">&#123;</span>
        my $result = xmmsc_playback_start<span style="color: black;">&#40;</span>$<span style="color: #66cc66;">!</span>connection<span style="color: black;">&#41;</span><span style="color: #66cc66;">;</span>
        xmmsc_result_wait<span style="color: black;">&#40;</span>$result<span style="color: black;">&#41;</span><span style="color: #66cc66;">;</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #008000;">True</span> <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #008000;">self</span>.<span style="color: black;">check</span>-result<span style="color: black;">&#40;</span>$result<span style="color: black;">&#41;</span><span style="color: #66cc66;">;</span>
&nbsp;
        warn <span style="color: #483d8b;">&quot;Playback start failed!&quot;</span><span style="color: #66cc66;">;</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #008000;">False</span><span style="color: #66cc66;">;</span>
    <span style="color: black;">&#125;</span>
&nbsp;
    method <span style="color: #66cc66;">!</span>check-result<span style="color: black;">&#40;</span>xmmsc_result_t $result<span style="color: black;">&#41;</span> returns Bool <span style="color: black;">&#123;</span>
        my $return_value = xmmsc_result_get_value<span style="color: black;">&#40;</span>$result<span style="color: black;">&#41;</span><span style="color: #66cc66;">;</span>
        my Bool $failed = xmmsv_is_error<span style="color: black;">&#40;</span>$return_value<span style="color: black;">&#41;</span><span style="color: #66cc66;">;</span>
&nbsp;
        <span style="color: #ff7700;font-weight:bold;">if</span> $failed <span style="color: black;">&#123;</span>
            xmmsv_get_error<span style="color: black;">&#40;</span>$return_value, my $error-<span style="color: #008000;">str</span><span style="color: black;">&#41;</span>
                <span style="color: #ff7700;font-weight:bold;">and</span> warn $error-<span style="color: #008000;">str</span><span style="color: #66cc66;">;</span>
        <span style="color: black;">&#125;</span>
&nbsp;
        xmmsc_result_unref<span style="color: black;">&#40;</span>$result<span style="color: black;">&#41;</span><span style="color: #66cc66;">;</span>
&nbsp;
        <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #ff7700;font-weight:bold;">not</span> $failed<span style="color: #66cc66;">;</span>
    <span style="color: black;">&#125;</span>
&nbsp;
    submethod BUILD<span style="color: black;">&#40;</span>$client_name, $path<span style="color: black;">&#41;</span> <span style="color: black;">&#123;</span>
        $<span style="color: #66cc66;">!</span>connection = xmmsc_init<span style="color: black;">&#40;</span>$client_name<span style="color: black;">&#41;</span><span style="color: #66cc66;">;</span>
        xmmsc_connect<span style="color: black;">&#40;</span>$<span style="color: #66cc66;">!</span>connection, $path<span style="color: black;">&#41;</span>
            <span style="color: #ff7700;font-weight:bold;">or</span> die <span style="color: #483d8b;">&quot;Connection failed with error: {xmmsc_get_last_error($!connection)}&quot;</span><span style="color: #66cc66;">;</span>
    <span style="color: black;">&#125;</span>
&nbsp;
    submethod DESTROY <span style="color: black;">&#123;</span>
        xmmsc_unref<span style="color: black;">&#40;</span>$<span style="color: #66cc66;">!</span>connection<span style="color: black;">&#41;</span><span style="color: #66cc66;">;</span>
    <span style="color: black;">&#125;</span>
<span style="color: black;">&#125;</span><span style="color: #66cc66;">;</span></pre></div></div>

<p>现在让魔法生效：</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">XMMS2::Client.<span style="color: #dc143c;">new</span>.<span style="color: black;">play</span><span style="color: #66cc66;">;</span></pre></div></div>

<p>成功连接了！然后程序返回了一个空PMC的错误。看起来NativeCall在传递空指针方面还得继续改进，毕竟是一个发展中的项目嘛。<br />
当然NativeCall已经是一个足以正式使用的模块了，比如你可以试试提供MySQL驱动的<a href="https://github.com/mberends/MiniDBI" target="_blank">MiniDBI模块</a>。<br />
（更新：前面的代码里我漏掉了xmmsc_result_wait()，虽然加上这个还是返回空PMC错误==!）</p>
<div id="downaspdf">
                    <a title="下载此文章的 PDF 文档" href="http://chenlinux.com/wp-content/plugins/down-as-pdf/generate.php?id=2778">
                      <span>Download as PDF</span>
                    </a>
                </div>

			<div class="fixed"></div>


		</div>


		<div class="under">


			<span class="categories">分类: </span><span><a href="http://chenlinux.com/category/ops/script" title="查看 脚本 中的全部文章" rel="category tag">脚本</a></span>

			<span class="tags">标签: </span><span><a href="http://chenlinux.com/tag/perl" rel="tag">perl</a>, <a href="http://chenlinux.com/tag/perl6advent" rel="tag">perl6advent</a></span>

		</div>


	</div>





