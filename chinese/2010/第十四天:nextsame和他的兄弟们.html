




	<div class="post" id="post-2767">


		<h2>2010年Perl6圣诞月历(十四)nextsame和他的兄弟们</h2>


		<div class="info">


			<span class="date">2011年12月14日</span>


			<span class="author"><a href="http://chenlinux.com/author/admin" title="由 admin 发布" rel="author">admin</a></span>

			

			

				<span class="addcomment"><a href="#respond">发表评论</a></span>


				<span class="comments"><a href="#comments">阅读评论</a></span>


			

			<div class="fixed"></div>


		</div>


		<div class="content">


			<p>也许你已经很熟悉在JAVA中用关键字super来代表给基类的方法或者构造。Perl6中也有类似的方法。不过在多重继承和混淆的世界里，叫它super的意义不大，所以我们叫它——nextsame。看看下面的例子吧：</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">class</span> A <span style="color: black;">&#123;</span>
    method sing <span style="color: black;">&#123;</span>
        say <span style="color: #483d8b;">&quot;life is but a dream.&quot;</span><span style="color: #66cc66;">;</span>
    <span style="color: black;">&#125;</span>
<span style="color: black;">&#125;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">class</span> B <span style="color: #ff7700;font-weight:bold;">is</span> A <span style="color: black;">&#123;</span>
    method sing <span style="color: black;">&#123;</span>
        say <span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;merrily,&quot;</span> xx <span style="color: #ff4500;">4</span><span style="color: black;">&#41;</span>.<span style="color: black;">join</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot; &quot;</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">;</span>
        nextsame<span style="color: #66cc66;">;</span>
    <span style="color: black;">&#125;</span>
<span style="color: black;">&#125;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">class</span> C <span style="color: #ff7700;font-weight:bold;">is</span> B <span style="color: black;">&#123;</span>
    method sing <span style="color: black;">&#123;</span>
        say <span style="color: #483d8b;">&quot;row, row, row your boat,&quot;</span><span style="color: #66cc66;">;</span>
        say <span style="color: #483d8b;">&quot;gently down the stream.&quot;</span><span style="color: #66cc66;">;</span>
        nextsame<span style="color: #66cc66;">;</span>
    <span style="color: black;">&#125;</span>
<span style="color: black;">&#125;</span></pre></div></div>

<p>然后，当你调用C.new.sing的时候，我们的类继承结果如下：</p>
<pre>row, row, row your boat,
gently down the stream.
merrily, merrily, merrily, merrily,
life is but a dream.</pre>
<p>你现在知道C.sing是怎样一步步从B.sing到A.sing的了。这些转换当然就是由nextsame调用来的。嗯，你看，跟java的super很像吧~<br />
除了继承链外，nextsame在其他地方也能发挥作用。下面这个例子就不涉及面向对象：</p>

<div class="wp_syntax"><div class="code"><pre class="perl" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">sub</span> bray <span style="color: #009900;">&#123;</span>
    say <span style="color: #ff0000;">&quot;EE-I-EE-I-OO.&quot;</span><span style="color: #339933;">;</span>
<span style="color: #009900;">&#125;</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># 啊，忘了加上第一行了~</span>
<span style="color: #0000ff;">&amp;bray</span><span style="color: #339933;">.</span>wrap<span style="color: #009900;">&#40;</span> <span style="color: #009900;">&#123;</span>
    say <span style="color: #ff0000;">&quot;Old MacDonald had a farm,&quot;</span><span style="color: #339933;">;</span>
    nextsame<span style="color: #339933;">;</span>
<span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
bray<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #666666; font-style: italic;"># Old MacDonald had a farm,</span>
        <span style="color: #666666; font-style: italic;"># EE-I-EE-I-OO.</span></pre></div></div>

<p>嗯，这就是另一个nextsame不叫super的原因了：它不一定要有基类，可以是无关基类的。相反，它还有一些更为普遍的现象。那是什么呢？<br />
每次我们运行一个调用的时候，都要花费掉一点语言的运行时间用来确认调用应该怎样正确的运行。这个部分叫做dispatcher(调度)。调度可以确保multi函数的调用恰当的工作：</p>

<div class="wp_syntax"><div class="code"><pre class="perl" style="font-family:monospace;">multi foo<span style="color: #009900;">&#40;</span>    <span style="color: #0000ff;">$x</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> say <span style="color: #ff0000;">&quot;Any argument&quot;</span> <span style="color: #009900;">&#125;</span>
multi foo<span style="color: #009900;">&#40;</span>Int <span style="color: #0000ff;">$x</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> say <span style="color: #ff0000;">&quot;Int argument&quot;</span> <span style="color: #009900;">&#125;</span>
foo<span style="color: #009900;">&#40;</span><span style="color: #cc66cc;">42</span><span style="color: #009900;">&#41;</span> <span style="color: #666666; font-style: italic;"># Int argument</span></pre></div></div>

<p>(而且如果在multi的第二个子程序里继续用nextsame的话，又会再调度到第一个去——不过目前Rakudo还没实现这个……)<br />
在Perl6里，调度无处不在！调度参与方法调用的过程，这样方法可以顺延整个继承链，就像本文最上面的例子那样；调度包裹着子例程，这样别的代码可以调用被包裹的代码；调度还出现在multi调度里，以便相互调用……总之，调度的原则是一样的，只是表现形式不一样而已。<br />
而nextsame就是一个很友好的跟你周围的调度器直接交谈的方式。对了，顺便说一下，nextsame这个命名，是因为它指示调度器去顺延到下一个(next)有着相同(same)签名的候选人。它还有其他变种，比如，你可以用在混淆里：</p>

<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">class</span> A <span style="color: black;">&#123;</span>
    method foo <span style="color: black;">&#123;</span> <span style="color: #483d8b;">&quot;OH HAI&quot;</span> <span style="color: black;">&#125;</span>
<span style="color: black;">&#125;</span>
&nbsp;
role LogFoo <span style="color: black;">&#123;</span>
    method foo <span style="color: black;">&#123;</span>
        note <span style="color: #483d8b;">&quot;.foo was called&quot;</span><span style="color: #66cc66;">;</span>
        nextsame<span style="color: #66cc66;">;</span>
    <span style="color: black;">&#125;</span>
<span style="color: black;">&#125;</span>
&nbsp;
my $logged_A = A.<span style="color: #dc143c;">new</span> but LogFoo<span style="color: #66cc66;">;</span>
&nbsp;
say $logged_A.<span style="color: black;">foo</span><span style="color: #66cc66;">;</span> <span style="color: #808080; font-style: italic;"># .foo was called</span>
                   <span style="color: #808080; font-style: italic;"># OH HAI</span></pre></div></div>

<p>我喜欢这种利用混淆来注入的做法。我曾经写过一篇<a href="http://strangelyconsistent.org/blog/dreaming-in-mixins" target="_blank">博文关于这个反面的</a>。jnthn还写过<a href="https://github.com/jnthn/test-mock" target="_blank">一个perl6模块</a>来利用它。<br />
虽然这么酷，但是nextsame其实不是什么新奇玩意儿。事实上，它不过是顺着面向对象的调用链的调度器的另一个例子而已。因为在角色(role)LogFoo和but混合起来的时候，自动创建了一个匿名子类，一切和LogFoo一样。这样角色的nextsame其实还是归结到继承链上的nextsame了。（但是我在用它的时候，用不着多多了解它。只要它还是这么神奇和好用就行了）<br />
总之，nextsame可以在各种你希望它起作用的地方运行，而且实现的就是你想要的效果。它就是顺着去找下一个东东嘛~<br />
嗯，nextsame还有关系很近几个表兄弟：<br />
nextsame             Defer with the same arguments, don&#8217;t return<br />
callsame             Defer with the same arguments, then  return<br />
nextwith($p1, $p2, &#8230;) Defer with these arguments, don&#8217;t return<br />
callwith($p1, $p2, &#8230;) Defer with these arguments, then  return<br />
一般情况下，nextsame能用的地方，他们也都能用~~</p>
<div id="downaspdf">
                    <a title="下载此文章的 PDF 文档" href="http://chenlinux.com/wp-content/plugins/down-as-pdf/generate.php?id=2767">
                      <span>Download as PDF</span>
                    </a>
                </div>

			<div class="fixed"></div>


		</div>


		<div class="under">


			<span class="categories">分类: </span><span><a href="http://chenlinux.com/category/ops/script" title="查看 脚本 中的全部文章" rel="category tag">脚本</a></span>

			<span class="tags">标签: </span><span><a href="http://chenlinux.com/tag/perl" rel="tag">perl</a>, <a href="http://chenlinux.com/tag/perl6advent" rel="tag">perl6advent</a></span>

		</div>


	</div>





