	<div class="post" id="post-2788">
		<h2>2010年Perl6圣诞月历(十八)ABC模块</h2>
		<div class="info">
			<span class="date">2011年12月14日</span>
			<span class="author"><a href="http://chenlinux.com/author/admin" title="由 admin 发布" rel="author">admin</a></span>
			
			
				<span class="addcomment"><a href="#respond">发表评论</a></span>
				<span class="comments"><a href="#comments">阅读评论</a></span>
			
			<div class="fixed"></div>
		</div>
		<div class="content">
			<p>今天不再和大家专注于Perl6的某个特性，而是带大家一起浏览一下ABC模块。我觉得这是一个很好的体现Perl6优势的例子。<br />
<a href="http://abcnotation.com/" target="_blank">ABC标记</a>是一个非常简单的文本文件格式，用来支持乐谱记录。它广泛运用在传统舞蹈音乐的世界，因为它轻便而强大，甚至支持吉格舞和圆旋舞。下面是一个例子：</p>
<pre>X:1
T:While Shepherds Watched Their Flocks
M:5/4
L:1/4
O:Green's Harbour, Newfoundland
K:A major
E|:[M:5/4] A A/B/ B2 A|B c/B/ A2 A/B/|
[M:6/4]c d/c/ B2 B2|[M:4/4] A3 E|AB AG|
FE FE|AB AG|F2 F2|E2 G2|A/G/ F/E/ DF|
[1 [M:6/4] E C/B,/ A,3 E:|[2 [M:5/4] E C/B,/ A,3|]
</pre>
<p>细节部分我就不说了——感兴趣的看<a href="http://abcnotation.com/blog/2010/01/31/how-to-understand-abc-the-basics/">指南</a>吧——但是文本本身格式非常简单。第一行是曲调的信息，余下的就是曲调本身。这个例子比较复杂，因为里面内嵌的时间签名都被更改了。比如[M:6/4]。<br />
我一直很惊讶为什么CPAN上没有处理ABC标记的模块，甚至有时候还想过自己写一个。不过<a href="http://www.norbeck.nu/abc/bnf/abc20bnf.htm" target="_blank">处理ABC标记</a>真的是一个比较复杂的过程，没多大进展就碰到问题后我放弃了。<br />
而使用Perl6的<a href="http://perl6advent.wordpress.com/2009/12/21/day-21-grammars-and-actions/" target="_blank">语法</a>，大概只需要<a href="https://github.com/colomon/ABC/blob/master/lib/ABC/Grammar.pm" target="_blank">60行简单的正则</a>，我就可以解析所有我感兴趣的乐谱（ABC格式里几个更复杂的特性，比如歌词和多人音乐还没实现）了。摘一段如下：</p>
<pre>
regex basenote { <[a..g]+[A..G]> }
regex octave { "'"+ | ","+ }
regex accidental { '^' | '^^' | '_' | '__' | '=' }
regex pitch { <accidental>? <basenote> <octave>? }
</pre>
<p>对比一下<a href="http://www.norbeck.nu/abc/bnf/abc20bnf.htm" target="_blank">BNF grammar for ABC</a>：</p>
<pre>	basenote ::= %x43 / %x44 / %x45 / %x46 / %x47 / %x41 / %x42 / %x63 / %x64 / %x65 / %x66 / %x67 / %x61 / %x62 ; CDEFGABcdefgab
octave ::= 1*"'" / 1*","
accidental ::= "^" / "^^" / "_" / "__" / "="
pitch ::= [accidental] basenote [octave]</pre>
<p>显然，这是一个非常简单的翻译过程。<br />
默认情况下，Perl6语法的解析功能只提供给你一个基本的Match对象。但是你可以添加一个指定操作的对象，用它来处理信息，就好像是通过语法解析的一样。比如下面的例子：</p>
<div class="wp_syntax"><div class="code"><pre class="python" style="font-family:monospace;">method rest<span style="color: black;">&#40;</span>$/<span style="color: black;">&#41;</span> <span style="color: black;">&#123;</span>
    make ABC::Rest.<span style="color: #dc143c;">new</span><span style="color: black;">&#40;</span>~$<span style="color: #66cc66;">&lt;</span>rest_type<span style="color: #66cc66;">&gt;</span>,
                       $<span style="color: #66cc66;">&lt;</span>note_length<span style="color: #66cc66;">&gt;</span>.<span style="color: black;">ast</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">;</span>
<span style="color: black;">&#125;</span></pre></div></div>
<p>不管rest方法成不成，它都返回一个<a href="https://github.com/colomon/ABC/blob/master/lib/ABC/Rest.pm" target="_blank">ABC::Rest</a>对象。这个对象的构造器通过rest_type表达式检查字符串。然后还有一个<a href="https://github.com/colomon/ABC/blob/master/lib/ABC/Duration.pm" target="_blank">ABC::Duration</a>对象，经过note_length的动作后创建出来。<br />
说到duration（持续时间），Perl6的一个特性让这块变得很容易。duration是一个精确的有理数类型。如果没有这个特性的话，我们就得自己手敲上一堆代码来实现类似的东西，以处理这些无法用浮点数表达的时间了。<br />
目前，还只有一个签名应用使用了这个工具——ABC模块里带的<a href="https://github.com/colomon/ABC/blob/master/bin/abc2ly.pl" target="_blank">abc2ly.pl</a>脚本。这个脚本可以转换ABC格式为Lilypond格式。Lilypond是一个开源的强大的音乐记谱系统，可以输出非常漂亮的谱子。这样就可以从ABC格式输出美观的乐谱了。（Lilypond源码包附带有一个abc2ly，但是好像不能用。我的abc2ly.pl也已经足够好用了，2011年我用它输出了一整本书）结束前，真的很高兴给大家带来上面<a href="http://harmonyware.com/tunes/shepherds.pdf" target="_blank">那首乐谱的pdf</a>，它就是用Rakudo和Lilypond工具处理生成的。</p>
<div id="downaspdf">
                    <a title="下载此文章的 PDF 文档" href="http://chenlinux.com/wp-content/plugins/down-as-pdf/generate.php?id=2788">
                      <span>Download as PDF</span>
                    </a>
                </div>
			<div class="fixed">/div>
		</div>
		<div class="under">
			<span class="categories">分类: </span><span><a href="http://chenlinux.com/category/ops/script" title="查看 脚本 中的全部文章" rel="category tag">脚本</a></span>
			<span class="tags">标签: </span><span><a href="http://chenlinux.com/tag/perl" rel="tag">perl</a>, <a href="http://chenlinux.com/tag/perl6advent" rel="tag">perl6advent</a></span>
		</div>
	</div>
